<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coordenadas del Restaurante - Charlotte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <%- include('../partials/inyectarHelpersCss.ejs') %>
    <style>
        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-[#f8fafc]">

    <div class="flex min-h-screen">
        <%- include('../partials/aside.ejs') %>

        <main class="flex-grow p-12">
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Coordenadas del Restaurante</h1>
                <p class="text-sm text-gray-500">Configura la ubicación del restaurante en el mapa.</p>
            </header>

            <div class="bg-white rounded-xl border border-gray-100 p-8">
                <div class="mb-6">
                    <div class="flex gap-4 mb-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Latitud</label>
                            <input type="number" id="inputLatitud" step="any" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Longitud</label>
                            <input type="number" id="inputLongitud" step="any" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Buscar por dirección</label>
                        <div class="flex gap-2">
                            <input type="text" id="inputBuscarDireccion" placeholder="Ej: Caracas, Venezuela" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">
                            <button id="btnBuscar" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                <i class="fa-solid fa-search mr-2"></i> Buscar
                            </button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <button id="btnGeolocalizacion" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            <i class="fa-solid fa-location-crosshairs mr-2"></i> Usar mi ubicación
                        </button>
                    </div>
                </div>

                <div id="map"></div>

                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="btnCancelar" class="btn-cancelar">Cancelar</button>
                    <button type="button" id="btnGuardar" class="btn-guardar">Guardar Coordenadas</button>
                </div>
            </div>
        </main>
    </div>

    <%- include('../partials/inyectarHelpersJs.ejs') %>
    <!-- Todos los demas scripts despues de estos que se inyectan -->
    <script>
        (function() {
            const notyf = window.seguridad_notyf || new Notyf();
            let mapa = null;
            let marcador = null;
            let coordenadasExistentes = null;

            // Referencias a elementos del DOM
            const inputLatitud = document.getElementById('inputLatitud');
            const inputLongitud = document.getElementById('inputLongitud');
            const inputBuscarDireccion = document.getElementById('inputBuscarDireccion');
            const btnBuscar = document.getElementById('btnBuscar');
            const btnGeolocalizacion = document.getElementById('btnGeolocalizacion');
            const btnGuardar = document.getElementById('btnGuardar');
            const btnCancelar = document.getElementById('btnCancelar');

            // Cargar coordenadas existentes
            async function cargarCoordenadas() {
                try {
                    const response = await httpSeguridadClient('/api/seguridad/restaurants', {
                        method: 'GET'
                    });

                    if (response.status === 404) {
                        // No hay coordenadas, usar valores por defecto
                        coordenadasExistentes = null;
                        inicializarMapa(10.506098, -66.895713); // Caracas por defecto
                        return;
                    }

                    if (!response.ok) {
                        throw new Error('Error al cargar coordenadas');
                    }

                    const data = await response.json();
                    coordenadasExistentes = data;

                    if (data.latitude && data.longitude) {
                        const lat = parseFloat(data.latitude);
                        const lng = parseFloat(data.longitude);
                        inputLatitud.value = lat;
                        inputLongitud.value = lng;
                        inicializarMapa(lat, lng);
                    } else {
                        inicializarMapa(10.506098, -66.895713); // Caracas por defecto
                    }
                } catch (error) {
                    console.error('Error cargando coordenadas:', error);
                    notyf.error('Error al cargar las coordenadas existentes');
                    inicializarMapa(10.506098, -66.895713); // Caracas por defecto
                }
            }

            // Inicializar mapa
            function inicializarMapa(lat, lng) {
                if (mapa) {
                    mapa.remove();
                }

                mapa = L.map('map').setView([lat, lng], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(mapa);

                // Crear marcador
                marcador = L.marker([lat, lng], { draggable: true }).addTo(mapa);

                // Actualizar inputs cuando se arrastra el marcador
                marcador.on('dragend', function() {
                    const pos = marcador.getLatLng();
                    inputLatitud.value = pos.lat.toFixed(8);
                    inputLongitud.value = pos.lng.toFixed(8);
                });

                // Actualizar marcador cuando se hace click en el mapa
                mapa.on('click', function(e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;
                    marcador.setLatLng([lat, lng]);
                    inputLatitud.value = lat.toFixed(8);
                    inputLongitud.value = lng.toFixed(8);
                });

                // Actualizar marcador cuando se cambian los inputs manualmente
                inputLatitud.addEventListener('change', actualizarMarcadorDesdeInputs);
                inputLongitud.addEventListener('change', actualizarMarcadorDesdeInputs);
            }

            // Actualizar marcador desde inputs
            function actualizarMarcadorDesdeInputs() {
                const lat = parseFloat(inputLatitud.value);
                const lng = parseFloat(inputLongitud.value);
                if (!isNaN(lat) && !isNaN(lng)) {
                    marcador.setLatLng([lat, lng]);
                    mapa.setView([lat, lng], mapa.getZoom());
                }
            }

            // Buscar por dirección
            async function buscarPorDireccion() {
                const direccion = inputBuscarDireccion.value.trim();
                if (!direccion) {
                    notyf.error('Por favor, ingresa una dirección');
                    return;
                }

                try {
                    // Usar Nominatim (OpenStreetMap) para geocodificación
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}&limit=1`);
                    const data = await response.json();

                    if (data.length === 0) {
                        notyf.error('No se encontró la dirección');
                        return;
                    }

                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    inputLatitud.value = lat.toFixed(8);
                    inputLongitud.value = lng.toFixed(8);
                    marcador.setLatLng([lat, lng]);
                    mapa.setView([lat, lng], 15);
                    notyf.success('Dirección encontrada');
                } catch (error) {
                    console.error('Error buscando dirección:', error);
                    notyf.error('Error al buscar la dirección');
                }
            }

            // Usar geolocalización del navegador
            function usarGeolocalizacion() {
                if (!navigator.geolocation) {
                    notyf.error('Tu navegador no soporta geolocalización');
                    return;
                }

                btnGeolocalizacion.disabled = true;
                btnGeolocalizacion.textContent = 'Obteniendo ubicación...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        inputLatitud.value = lat.toFixed(8);
                        inputLongitud.value = lng.toFixed(8);
                        marcador.setLatLng([lat, lng]);
                        mapa.setView([lat, lng], 15);
                        notyf.success('Ubicación obtenida');
                        btnGeolocalizacion.disabled = false;
                        btnGeolocalizacion.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i> Usar mi ubicación';
                    },
                    (error) => {
                        console.error('Error geolocalización:', error);
                        notyf.error('Error al obtener tu ubicación');
                        btnGeolocalizacion.disabled = false;
                        btnGeolocalizacion.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i> Usar mi ubicación';
                    }
                );
            }

            // Guardar coordenadas
            async function guardarCoordenadas() {
                const lat = parseFloat(inputLatitud.value);
                const lng = parseFloat(inputLongitud.value);

                if (isNaN(lat) || isNaN(lng)) {
                    notyf.error('Por favor, ingresa coordenadas válidas');
                    return;
                }

                const body = {
                    latitude: lat,
                    longitude: lng
                };

                try {
                    btnGuardar.disabled = true;
                    btnGuardar.textContent = 'Guardando...';

                    let response;
                    if (coordenadasExistentes === null) {
                        // Crear nuevas coordenadas
                        response = await httpSeguridadClient('/api/seguridad/restaurants', {
                            method: 'POST',
                            body: JSON.stringify(body)
                        });
                    } else {
                        // Actualizar coordenadas existentes
                        response = await httpSeguridadClient(`/api/seguridad/restaurants/${coordenadasExistentes.id}`, {
                            method: 'PATCH',
                            body: JSON.stringify(body)
                        });
                    }

                    const data = await response.json();

                    if (!response.ok) {
                        if (data.errors && Array.isArray(data.errors)) {
                            const errorMsg = data.errors.map(e => e.message).join(', ');
                            notyf.error(errorMsg);
                        } else {
                            const errorMsg = data.message || response.statusText || 'Error al guardar las coordenadas';
                            notyf.error(errorMsg);
                        }
                        return;
                    }

                    coordenadasExistentes = data;
                    notyf.success('Coordenadas guardadas exitosamente');

                } catch (error) {
                    console.error('Error guardando coordenadas:', error);
                    const errorMsg = error.message || 'Error al guardar las coordenadas. Por favor, intenta nuevamente.';
                    notyf.error(errorMsg);
                } finally {
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = 'Guardar Coordenadas';
                }
            }

            // Event listeners
            btnBuscar.addEventListener('click', buscarPorDireccion);
            inputBuscarDireccion.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    buscarPorDireccion();
                }
            });
            btnGeolocalizacion.addEventListener('click', usarGeolocalizacion);
            btnGuardar.addEventListener('click', guardarCoordenadas);
            btnCancelar.addEventListener('click', () => {
                window.location.href = '/seguridad';
            });

            // Inicializar
            document.addEventListener('DOMContentLoaded', () => {
                cargarCoordenadas();
            });
        })();
    </script>
</body>
</html>
